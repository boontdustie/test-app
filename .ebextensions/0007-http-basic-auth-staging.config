Resources:
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          buckets: ["elasticbeanstalk-us-west-2-451517172927"]
          roleName:
            "Fn::GetOptionSetting":
              Namespace: "aws:asg:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"

  sslSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0

files:
  /etc/nginx/conf.d/https.conf:
    mode: "000755"
    owner: root
    group: root
    content: |
      server {
          listen       443 ssl;
          listen       [::]:443 ssl;
          server_name  localhost;

          ssl                  on;
          ssl_certificate      /etc/pki/tls/certs/server.crt;
          ssl_certificate_key  /etc/pki/tls/certs/server.key;

          ssl_session_cache          shared:SSL:1m;
          ssl_session_timeout        10m;
          ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
          ssl_ciphers                HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP;
          ssl_prefer_server_ciphers  on;

          location / {
              proxy_pass           http://my_app;
              proxy_set_header     Host $host;
              proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header     X-Forwarded-Proto https;
              proxy_redirect off;
          }
      }

  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: https://s3-us-west-2.amazonaws.com/elasticbeanstalk-us-west-2-451517172927/server.crt

  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: https://s3-us-west-2.amazonaws.com/elasticbeanstalk-us-west-2-451517172927/privatekey.pem

  /tmp/deployment/nginx_ssl.sh:
    mode: "000755"
    content: |
      if [ "$RACK_ENV" == "staging" ]; then
        sed -i 's/$proxy_add_x_forwarded_for;/$proxy_add_x_forwarded_for;\n   auth_basic "Restricted";\n    auth_basic_user_file \/etc\/nginx\/.htpasswd;\n/' /etc/nginx/conf.d/https.conf
      fi

container_commands:
  01nginx_ssl:
    command: "/tmp/deployment/nginx_ssl.sh"
  02restart_nginx:
    command: "service nginx restart"